import { NextRequest, NextResponse } from 'next/server';
import { requireAuth } from '@onecoach/lib-core';
import { prisma } from '@onecoach/lib-core';

export const dynamic = 'force-dynamic';

export async function GET(_req: NextRequest) {
  const userOrError = await requireAuth();
  if (userOrError instanceof NextResponse) return userOrError;

  const url = new URL(_req.url);
  const q = url.searchParams.get('q')?.trim() || '';
  const limit = Math.min(parseInt(url.searchParams.get('limit') || '100', 10), 200);

  const where = q ? { name: { contains: q, mode: 'insensitive' as const } } : {};
  const rows = await prisma.muscles.findMany({ where, orderBy: { name: 'asc' }, take: limit });

  type MuscleType = (typeof rows)[number];
  return NextResponse.json({ data: rows.map((r: MuscleType) => ({ id: r.id, name: r.name })) });
}
